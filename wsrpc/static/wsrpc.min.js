(function(g){g.WSRPC=function(n,p){function q(c){setTimeout(function(){try{a.socket=l(),a.serial=1}catch(b){c("onerror",b),delete a.socket,e(b)}},p||1E3)}function l(c){function b(c,h){for(;0<a.oneTimeEventStore[c].length;){var b=a.oneTimeEventStore[c].shift();b.hasOwnProperty("resolve")&&b.promise.isPending()&&b.resolve()}for(var f in a.eventStore[c]){b=a.eventStore[c][f];try{b(h)}catch(d){d.hasOwnProperty("stack")?e(d.stack):e("Event function "+b+" raised unknown error: "+d)}}}var f=new WebSocket(n),
d=function(){for(;0<a.callQueue.length;){var c=a.callQueue.shift(),b=a.store[c.serial];delete a.store[c.serial];b&&b.promise.isPending()&&b.reject("WebSocket error occurred")}};f.onclose=function(r){e("WSRPC: ONCLOSE CALLED (STATE: "+a["public"].state()+")");k(r);for(var h in a.store)a.store[h].hasOwnProperty("reject")&&a.store[h].promise.isPending()&&a.store[h].reject("Connection closed");d();b("onclose",c);b("onchange",c);q(b)};f.onerror=function(c){e("WSRPC: ONERROR CALLED (STATE: "+a["public"].state()+
")");k(c);d();b("onerror",c);b("onchange",c);e(["WebSocket has been closed by error: ",c])};f.onopen=function(c){e("WSRPC: ONOPEN CALLED (STATE: "+a["public"].state()+")");for(k(c);0<a.callQueue.length;)a.socket.send(JSON.stringify(a.callQueue.shift(),0,1));b("onconnect",c);b("onchange",c)};f.onmessage=function(c){e("WSRPC: ONMESSAGE CALLED ("+a["public"].state()+")");k(c);var b=null;if("message"==c.type)try{if(b=JSON.parse(c.data),e(b.data),b.hasOwnProperty("type")&&"call"===b.type){if(!a.routes.hasOwnProperty(b.call))throw Error("Route not found");
out={serial:b.serial,type:"callback",data:a.routes[b.call](b.arguments)};a.socket.send(JSON.stringify(out))}else if(b.hasOwnProperty("type")&&"error"===b.type){if(!a.store.hasOwnProperty(b.serial))return e("Unknown callback");var d=a.store[b.serial];if("undefined"===typeof d)return e("Confirmation without handler");delete a.store[b.serial];e("REJECTING: "+b.data);d.reject(b.data)}else{d=a.store[b.serial];if("undefined"===typeof d)return e("Confirmation without handler");delete a.store[b.serial];return"callback"===
b.type?d.resolve(b.data):d.reject(b.data)}}catch(f){err={data:f.message,type:"error",serial:b?b.serial:null},a.socket.send(JSON.stringify(err)),e(f.stack)}};return f}var a=this;a.serial=1;a.eventId=0;a.socketStarted=!1;a.eventStore={onconnect:{},onerror:{},onclose:{},onchange:{}};a.oneTimeEventStore={onconnect:[],onerror:[],onclose:[],onchange:[]};a.callQueue=[];var e=function(a){g.WSRPC.DEBUG&&("group"in console&&"groupEnd"in console?(console.group("WSRPC.DEBUG"),console.debug(a),console.groupEnd()):
console.debug(a))},k=function(a){g.WSRPC.TRACE&&("group"in console&&"groupEnd"in console&&"dir"in console?(console.group("WSRPC.TRACE"),"data"in a?console.dir(JSON.parse(a.data)):console.dir(a),console.groupEnd()):"data"in a?console.log("OBJECT DUMP: "+a.data):console.log("OBJECT DUMP: "+a))},m={0:"CONNECTING",1:"OPEN",2:"CLOSING",3:"CLOSED"};a.routes={};a.store={};a["public"]={call:function(c,b,f){a.serial+=2;var d=Q.defer();c={serial:a.serial,call:c,arguments:b};b=a["public"].state();"OPEN"===b?
(a.store[a.serial]=d,a.socket.send(JSON.stringify(c))):"CONNECTING"===b?(e("SOCKET IS: "+b),a.store[a.serial]=d,a.callQueue.push(c)):(e("SOCKET IS: "+b),f&&f.noWait?d.reject("Socket is: "+b):(a.store[a.serial]=d,a.callQueue.push(c)));return d.promise},init:function(){e("Websocket initializing..")},addRoute:function(c,b){a.routes[c]=b},addEventListener:function(c,b){return a.eventStore[c][a.eventId++]=b},onEvent:function(c){var b=Q.defer();a.oneTimeEventStore[c].push(b);return b.promise},removeEventListener:function(c,
b){return b<a.eventStore[c].length?(a.eventStore[c].splice(b,1),!0):!1},deleteRoute:function(c){return delete a.routes[c]},destroy:function(){function c(){}a.socket.onclose=c;a.socket.onerror=c;return a.socket.close()},state:function(){return a.socketStarted&&a.socket?m[a.socket.readyState]:m[3]},connect:function(){a.socketStarted=!0;a.socket=l()}};a["public"].addRoute("log",function(a){console.info("Websocket sent: "+a)});a["public"].addRoute("ping",function(a){return a});return a["public"]};g.WSRPC.DEBUG=
!1;g.WSRPC.TRACE=!1})(this);